<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Directory</title>
    <style>
        html, body { height: 100%; margin: 0; }
        body { font-family: Arial, sans-serif; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 35%; max-width: 520px; min-width: 260px; border-right: 1px solid #ddd; overflow: auto; padding: 16px; }
        .viewer { flex: 1; height: 100%; }
        .viewer iframe { width: 100%; height: 100%; border: 0; }
        .folder { font-weight: bold; cursor: pointer; }
        .children { margin-left: 16px; }
        ul { list-style: none; padding-left: 0; }
        li { margin: 4px 0; }
        a.file-link { color: #0b62d6; text-decoration: none; cursor: pointer; }
        a.file-link:hover { text-decoration: underline; }
        .muted { color: #777; font-weight: normal; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>PDF Directory</h2>
            <div id="directory-content"></div>
        </div>
        <div class="viewer">
            <div id="controls" style="padding:8px; border-bottom:1px solid #ddd; display:flex; gap:8px; align-items:center;">
                <button id="btnTop" title="Scroll to top">Top</button>
                <label>Page:
                    <input type="number" id="pageInput" min="1" style="width:72px" />
                </label>
                <button id="btnGoPage" title="Go to page">Go</button>
                <button id="btnPrev" title="Previous page">Prev</button>
                <button id="btnNext" title="Next page">Next</button>
                <label>Scroll Y:
                    <input type="number" id="scrollDelta" value="300" style="width:80px" />
                </label>
                <button id="btnScrollUp">Up</button>
                <button id="btnScrollDown">Down</button>
            </div>
            <iframe id="pdfViewer" title="PDF Viewer"></iframe>
        </div>
    </div>

    <script>
        // Directory structure from server
        const structure = {{ structure | tojson | safe }};

        // Build nested list with clickable links
        function renderDirectory(structure, container, pathPrefix = '') {
            const ul = document.createElement('ul');
            for (const [name, item] of Object.entries(structure)) {
                const li = document.createElement('li');
                li.className = item.type;
                if (item.type === 'file') {
                    const a = document.createElement('a');
                    a.className = 'file-link';
                    a.textContent = name;
                    // The server expects rel_path for /pdf/<rel_path>
                    const relPath = item.path; // already relative to root
                    a.href = '#';
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        openInViewer(relPath);
                    });
                    li.appendChild(a);
                } else if (item.type === 'folder') {
                    const header = document.createElement('span');
                    header.textContent = name;
                    header.className = 'folder';
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'children';
                    if (item.children && Object.keys(item.children).length > 0) {
                        renderDirectory(item.children, childrenContainer, pathPrefix + name + '/');
                    } else {
                        const empty = document.createElement('div');
                        empty.className = 'muted';
                        empty.textContent = '(empty)';
                        childrenContainer.appendChild(empty);
                    }
                    li.appendChild(header);
                    li.appendChild(childrenContainer);
                }
                ul.appendChild(li);
            }
            container.appendChild(ul);
        }

        // --- Programmatic control helpers for PDF.js viewer ---
        let viewerReadyPromise = null;
        function getViewerAppAsync() {
            if (!viewerReadyPromise) {
                viewerReadyPromise = new Promise((resolve) => {
                    const iframe = document.getElementById('pdfViewer');
                    const wait = () => {
                        try {
                            const w = iframe.contentWindow;
                            if (w && w.PDFViewerApplication && w.PDFViewerApplication.initializedPromise) {
                                w.PDFViewerApplication.initializedPromise.then(() => resolve(w.PDFViewerApplication));
                                return;
                            }
                        } catch (e) { /* same-origin only; our setup is same-origin */ }
                        setTimeout(wait, 100);
                    };
                    wait();
                });
            }
            return viewerReadyPromise;
        }
        async function scrollToPage(n) {
            const app = await getViewerAppAsync();
            const max = app.pdfDocument ? app.pdfDocument.numPages : null;
            const pageNum = Math.max(1, max ? Math.min(n, max) : n);
            app.page = pageNum; // jumps and scrolls to that page
        }
        async function nextPage() { const app = await getViewerAppAsync(); app.page = Math.min(app.page + 1, app.pdfDocument.numPages); }
        async function prevPage() { const app = await getViewerAppAsync(); app.page = Math.max(app.page - 1, 1); }
        async function scrollByDelta(deltaY) {
            const app = await getViewerAppAsync();
            const container = app.pdfViewer && app.pdfViewer.container;
            if (container) container.scrollTop += deltaY;
        }
        async function scrollToTop() {
            const app = await getViewerAppAsync();
            const container = app.pdfViewer && app.pdfViewer.container;
            if (container) container.scrollTop = 0;
        }
        function openInViewer(relPath) {
            // Use the existing PDF.js viewer if present in /static/js/pdfjs or fall back to native iframe
            // Prefer bundled PDF.js in project root static/js/pdfjs/web/viewer.html, served by Flask static.
            // We need a URL that the iframe can reach. Our Flask app serves PDFs at /pdf/<rel_path>.
            const fileUrl = encodeURIComponent(`/pdf/${relPath}`);
            const viewerPaths = [
                '/static/js/pdfjs/web/viewer.html?file=', // project root static
                // fallback to direct PDF (browser viewer)
                null
            ];
            const iframe = document.getElementById('pdfViewer');

            // Try PDF.js first; if it fails to load, fall back
            const tryPdfJs = () => {
                iframe.src = viewerPaths[0] + fileUrl;
            };
            const fallbackDirect = () => {
                iframe.src = `/pdf/${relPath}`;
            };

            // Attempt PDF.js; after load, we keep it. On error, fallback.
            iframe.onload = () => {
                // Clear cached promise so getViewerAppAsync will attach to new document
                viewerReadyPromise = null;
                // Optionally set the page input to 1
                const pageInput = document.getElementById('pageInput');
                if (pageInput) pageInput.value = 1;
            };
            iframe.onerror = null;
            tryPdfJs();
            // If PDF.js isn't available (404), fallback could be using direct URL:
            // iframe.src = `/pdf/${relPath}`;
        }

        // Wire up control buttons
        window.addEventListener('DOMContentLoaded', () => {
            const btnTop = document.getElementById('btnTop');
            const btnGoPage = document.getElementById('btnGoPage');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const btnUp = document.getElementById('btnScrollUp');
            const btnDown = document.getElementById('btnScrollDown');
            const pageInput = document.getElementById('pageInput');
            const scrollDelta = document.getElementById('scrollDelta');
            if (btnTop) btnTop.onclick = () => scrollToTop();
            if (btnGoPage) btnGoPage.onclick = () => { const n = parseInt(pageInput.value || '1', 10); scrollToPage(n); };
            if (btnPrev) btnPrev.onclick = () => prevPage();
            if (btnNext) btnNext.onclick = () => nextPage();
            if (btnUp) btnUp.onclick = () => { const d = parseInt(scrollDelta.value || '300', 10); scrollByDelta(-Math.abs(d)); };
            if (btnDown) btnDown.onclick = () => { const d = parseInt(scrollDelta.value || '300', 10); scrollByDelta(Math.abs(d)); };
        });

        const directoryContent = document.getElementById('directory-content');
        renderDirectory(structure, directoryContent);
    </script>
</body>
</html>